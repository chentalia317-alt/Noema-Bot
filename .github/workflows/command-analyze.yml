name: "Command: /analyze"

on:
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write      # å›æ¨ç»“æœéœ€è¦
  issues: write
  pull-requests: write

jobs:
  analyze:
    # æ‰‹åŠ¨è§¦å‘ç›´æ¥è·‘ï¼›è¯„è®ºè§¦å‘ä»…é™ Issue ä¸”ä»¥ /analyze å¼€å¤´
    if: >
      ${{
        github.event_name == 'workflow_dispatch' ||
        (
          github.event_name == 'issue_comment' &&
          github.event.issue.pull_request == null &&
          startsWith(github.event.comment.body, '/analyze')
        )
      }}
    runs-on: ubuntu-latest

    env:
      TARGET_BRANCH: ${{ github.event.repository.default_branch }}   # é€šå¸¸æ˜¯ main
      # è‹¥æƒ³é™åˆ¶åªèƒ½æŸä¸ªç”¨æˆ·è¯„è®ºè§¦å‘ï¼Œå¡«ç”¨æˆ·åï¼›ä¸éœ€è¦åˆ™ç•™ç©º
      ALLOWED_USER: ""

    steps:
      # â€”â€”(å¯é€‰) ç™½åå•ï¼šä»…åœ¨è¯„è®ºè§¦å‘æ—¶ç”Ÿæ•ˆâ€”â€”
      - name: Guard allowlist
        if: ${{ github.event_name == 'issue_comment' && env.ALLOWED_USER != '' && github.event.comment.user.login != env.ALLOWED_USER }}
        run: |
          echo "Blocked: user '${{ github.event.comment.user.login }}' is not allowed."
          exit 1

      - name: Checkout repository (no persisted creds)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # â€”â€”å‚æ•°è§£æï¼šè¯„è®ºè§¦å‘è§£æ /analyze file=xxxï¼›æ‰‹åŠ¨è§¦å‘ç»™ç©ºé»˜è®¤â€”â€”
      - name: Parse /analyze args (issue_comment)
        if: ${{ github.event_name == 'issue_comment' }}
        id: args
        shell: bash
        run: |
          RAW="${{ github.event.comment.body }}"
          FILE=$(echo "$RAW" | sed -n 's/.*file=\([A-Za-z0-9._\/\-]\+\).*/\1/p')
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

      - name: Set default args (manual dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        id: args
        run: echo "file=" >> "$GITHUB_OUTPUT"

      - name: Run analysis script
        env:
          FILE: ${{ steps.args.outputs.file }}   # ä¸ºç©ºåˆ™åˆ†æ data/ ä¸‹æ‰€æœ‰å¯è¯†åˆ«æ–‡ä»¶
        run: |
          echo "Analyzing FILE=${FILE:-<ALL in data/>}"
          python scripts/analyze.py

      # â€”â€”å¯é€‰ï¼šæŠŠ Markdown è½¬ä¸º HTMLï¼Œå¹¶æä¾›ä¸‰ç§â€œä¿å­˜æ–¹å¼â€â€”â€”
      - name: Set up Node (for Quarkdown)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Build HTML report from Markdown (optional)
        run: |
          mkdir -p reports
          if [ -f "reports/REPORT.md" ]; then
            npx -y quarkdown-cli@latest compile reports/REPORT.md -o reports/noema-report.qd || true
            npx -y quarkdown-cli@latest render  reports/noema-report.qd -o reports/noema-report.html || true
          fi

      # æ–¹æ¡ˆ Aï¼šä¸Šä¼ ä¸º artifactï¼ˆæœ€çœäº‹ï¼‰
      - name: Upload report artifact
        if: success() && hashFiles('reports/**') != ''
        uses: actions/upload-artifact@v4
        with:
          name: analyze-report
          path: reports/

      # æ–¹æ¡ˆ Bï¼šæäº¤å›ä»“åº“ï¼ˆreport/ ä¸ docs/ï¼‰
      - name: Prepare Git identity
        run: |
          git config user.name  "Noema-Bot"
          git config user.email "noema-bot@users.noreply.github.com"

      - name: Publish HTML to docs/ for GitHub Pages (optional)
        run: |
          if [ -f reports/noema-report.html ]; then
            mkdir -p docs/reports
            cp -f reports/noema-report.html docs/reports/noema-report.html
          fi

      - name: Commit report artifacts to repo (optional)
        run: |
          git add reports/ report_summary.json docs/ || true
          git diff --cached --quiet && echo "No changes to commit." || git commit -m "chore: update analysis artifacts [skip ci]"

      - name: Push to ${TARGET_BRANCH}
        if: ${{ success() }}
        env:
          GH_PAT: ${{ secrets.BOT_TOKEN }}   # å¦‚æ—  PATï¼Œä¹Ÿå¯æ”¹ç”¨ GITHUB_TOKENï¼šè§ä¸‹æ–¹æ³¨é‡Š
        run: |
          if git rev-parse -q --verify HEAD >/dev/null; then
            git push "https://${GH_PAT}@github.com/${{ github.repository }}.git" HEAD:${TARGET_BRANCH}
          fi

      # è¯„è®ºè§¦å‘æ—¶ï¼ŒæŠŠç®€è¦ç»“æœå›å¸–
      - name: Read report summary
        id: summary
        run: |
          if command -v jq >/dev/null 2>&1; then :
          else sudo apt-get update -y && sudo apt-get install -y jq; fi
          if [ -f report_summary.json ]; then
            MD=$(jq -r '.markdown' report_summary.json)
          else
            MD="No summary produced by analysis."
          fi
          {
            echo "md<<EOF"
            echo "$MD"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Comment back as Noema-Bot
        if: ${{ github.event_name == 'issue_comment' }}
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.BOT_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ğŸ¤– **Noema-Bot** finished the analysis.

            **Reports directory:**  
            https://github.com/${{ github.repository }}/tree/${{ env.TARGET_BRANCH }}/reports

            - Markdown summary:  
              https://github.com/${{ github.repository }}/blob/${{ env.TARGET_BRANCH }}/reports/REPORT.md
            - Quarkdown HTML (if generated):  
              https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/reports/noema-report.html
            ---
            ${{ steps.summary.outputs.md }}

    concurrency:
      group: a

name: "Command: /analyze"

on:
  issue_comment:
    types: [created]
  workflow_dispatch:

permissions:
  contents: write
  issues: write

jobs:
  analyze:
    # åªåœ¨ã€Œæ™®é€š Issue çš„è¯„è®ºã€ä¸”ä»¥ /analyze å¼€å¤´æ—¶è§¦å‘
    if: ${{ github.event.issue.pull_request == null && startsWith(github.event.comment.body, '/analyze') }}
    runs-on: ubuntu-latest
    env:
      TARGET_BRANCH: ${{ github.event.repository.default_branch }} # å¯¹äº Issueï¼Œæ¨åˆ°é»˜è®¤åˆ†æ”¯ï¼ˆé€šå¸¸æ˜¯ mainï¼‰

    steps:
      - name: Checkout repository (no persisted creds)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false  # å…³é”®ï¼šç¦ç”¨ GITHUB_TOKEN çš„é»˜è®¤å‡­æ®

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run analysis script
        run: python scripts/analyze.py

      # æˆ‘è‡ªå·±çš„æœºå™¨äººå¼€å§‹æäº¤
      - name: Configure git as Noema-Bot
        run: |
          git config user.name "Noema-Bot"
          git config user.email "noema-bot@users.noreply.github.com"

      - name: Commit report artifacts
        run: |
          git add reports/ report_summary.json || true
          # è‹¥æ²¡æœ‰å˜åŒ–ï¼Œé¿å…å¤±è´¥
          git diff --cached --quiet && echo "No changes to commit." || git commit -m "chore: update analysis artifacts [skip ci]"

      - name: Push with BOT_TOKEN (PAT)
        if: ${{ success() }}
        env:
          GH_PAT: ${{ secrets.BOT_TOKEN }}   # æˆ‘è‡ªå·±çš„æœºå™¨äººPAT
        run: |
          # è‹¥æ²¡æœ‰æ–°æäº¤åˆ™è·³è¿‡æ¨é€
          if git rev-parse -q --verify HEAD >/dev/null; then
            git push "https://${GH_PAT}@github.com/${{ github.repository }}.git" HEAD:${TARGET_BRANCH}
          fi

      - name: Comment back as Noema-Bot
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ secrets.BOT_TOKEN }}   # ç”¨åŒä¸€ä¸ª PAT ä½œä¸ºæœºå™¨äººå‘è¯„è®º
          issue-number: ${{ github.event.issue.number }}
          body: |
            ğŸ¤– Hello! I'm **Noema-Bot** â€” your assistant.
            I've received your command and finished the analysis. Reports have been updated in `/reports`.
